#!/bin/sh

# For each chart whose version was bumped in the staged changes,
# verify that CHANGELOG.md is also staged and mentions the new version.

status=0

for chart_yaml in $(git diff --cached --name-only -- 'charts/*/Chart.yaml'); do
    # Only care if the version line actually changed
    version=$(git diff --cached -U0 -- "$chart_yaml" \
        | grep '^+version:' \
        | head -1 \
        | sed 's/^+version:[[:space:]]*//')

    [ -z "$version" ] && continue

    chart_name=$(echo "$chart_yaml" | cut -d/ -f2)

    # Check CHANGELOG.md is staged
    if ! git diff --cached --name-only | grep -q '^CHANGELOG.md$'; then
        echo "error: $chart_name bumped to $version but CHANGELOG.md is not staged"
        status=1
        continue
    fi

    # Check the staged CHANGELOG.md mentions this chart+version
    if ! git diff --cached -- CHANGELOG.md | grep -q "\`$chart_name\` $version"; then
        echo "error: CHANGELOG.md is missing an entry for \`$chart_name\` $version"
        status=1
    fi
done

exit $status
